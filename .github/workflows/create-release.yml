name: Create GitHub Release

on:
  push:
    branches:
      - main  # Triggers on pushes to main branch

permissions:
  contents: write
  pull-requests: read

jobs:
  create-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Find DMG files and extract version
      id: find_dmg
      run: |
        # Find all DMG files matching SwiftGPT-*.dmg pattern
        DMG_FILES=$(ls SwiftGPT-*.dmg 2>/dev/null || echo "")
        
        if [ -z "$DMG_FILES" ]; then
          echo "âŒ No SwiftGPT-*.dmg files found"
          echo "dmg_exists=false" >> $GITHUB_OUTPUT
          echo "Available files:"
          ls -la
          exit 0
        fi
        
        # Get the first (and hopefully only) DMG file
        DMG_FILE=$(echo "$DMG_FILES" | head -n 1)
        echo "âœ… Found DMG: $DMG_FILE"
        
        # Extract version from filename (SwiftGPT-1.1.dmg -> 1.1)
        VERSION=$(echo "$DMG_FILE" | sed 's/SwiftGPT-\(.*\)\.dmg/\1/')
        
        echo "dmg_exists=true" >> $GITHUB_OUTPUT
        echo "dmg_file=$DMG_FILE" >> $GITHUB_OUTPUT
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        
        echo "ğŸ“¦ DMG File: $DMG_FILE"
        echo "ğŸ·ï¸  Version: $VERSION"
        echo "ğŸ·ï¸  Tag: v$VERSION"
        
    - name: Check if release already exists
      id: check_release
      run: |
        TAG="v${{ steps.find_dmg.outputs.version }}"
        
        # Check if release already exists
        RELEASE_EXISTS=$(gh release view "$TAG" --json id 2>/dev/null | jq -r '.id // empty' || echo "")
        
        if [ -n "$RELEASE_EXISTS" ]; then
          echo "release_exists=true" >> $GITHUB_OUTPUT
          echo "release_id=$RELEASE_EXISTS" >> $GITHUB_OUTPUT
          echo "ğŸ”„ Release $TAG already exists (ID: $RELEASE_EXISTS)"
          echo "â„¹ï¸  Will update existing release with new DMG"
        else
          echo "release_exists=false" >> $GITHUB_OUTPUT
          echo "âœ¨ Release $TAG does not exist, will create new release"
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create Release
      if: steps.find_dmg.outputs.dmg_exists == 'true' && steps.check_release.outputs.release_exists == 'false'
      id: create_release
      run: |
        TAG="${{ steps.find_dmg.outputs.tag }}"
        VERSION="${{ steps.find_dmg.outputs.version }}"
        DMG_FILE="${{ steps.find_dmg.outputs.dmg_file }}"
        
        # Create release with GitHub CLI
        gh release create "$TAG" "$DMG_FILE" \
          --title "SwiftGPT $VERSION" 
        
        echo "âœ… Release $TAG created successfully!"
        echo "ğŸ“¦ DMG uploaded: $DMG_FILE"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Update Existing Release
      if: steps.find_dmg.outputs.dmg_exists == 'true' && steps.check_release.outputs.release_exists == 'true'
      id: update_release
      run: |
        TAG="${{ steps.find_dmg.outputs.tag }}"
        VERSION="${{ steps.find_dmg.outputs.version }}"
        DMG_FILE="${{ steps.find_dmg.outputs.dmg_file }}"
        
        echo "ğŸ”„ Updating existing release $TAG with new DMG..."
        
        # First, delete the old DMG asset if it exists
        OLD_ASSETS=$(gh release view "$TAG" --json assets --jq '.assets[].name' | grep "SwiftGPT-.*\.dmg" || echo "")
        
        if [ -n "$OLD_ASSETS" ]; then
          echo "ğŸ—‘ï¸  Removing old DMG assets: $OLD_ASSETS"
          for asset in $OLD_ASSETS; do
            gh release delete-asset "$TAG" "$asset" --yes || echo "Asset $asset not found or already deleted"
          done
        fi
        
        # Upload the new DMG
        echo "ğŸ“¦ Uploading new DMG: $DMG_FILE"
        gh release upload "$TAG" "$DMG_FILE" --clobber
        
        
        echo "âœ… Release $TAG updated successfully!"
        echo "ğŸ“¦ DMG replaced: $DMG_FILE"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Summary
      run: |
        if [ "${{ steps.find_dmg.outputs.dmg_exists }}" == "false" ]; then
          echo "âŒ No DMG files found!"
          echo "ğŸ’¡ Make sure you have a SwiftGPT-*.dmg file in the repository"
          echo "ğŸ“ Current files:"
          ls -la
        elif [ "${{ steps.check_release.outputs.release_exists }}" == "true" ]; then
          if [ "${{ steps.update_release.conclusion }}" == "success" ]; then
            echo "ğŸ”„ Release v${{ steps.find_dmg.outputs.version }} updated successfully!"
            echo "ğŸ“¦ DMG replaced: ${{ steps.find_dmg.outputs.dmg_file }}"
            echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.find_dmg.outputs.version }}"
          else
            echo "âŒ Failed to update release v${{ steps.find_dmg.outputs.version }}"
            echo "ğŸ“¦ DMG: ${{ steps.find_dmg.outputs.dmg_file }}"
            echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.find_dmg.outputs.version }}"
          fi
        else
          echo "âœ… New release v${{ steps.find_dmg.outputs.version }} created successfully!"
          echo "ğŸ“¦ DMG uploaded: ${{ steps.find_dmg.outputs.dmg_file }}"
          echo "ğŸŒ GitHub Pages will update automatically with the new appcast.xml"
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.find_dmg.outputs.version }}"
        fi
